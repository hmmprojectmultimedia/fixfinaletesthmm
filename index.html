<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adsmax Studio Pro (Tanpa Model)</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            color: #f9fafb;
        }
        .style-card {
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .style-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.1), 0 4px 6px -2px rgba(34, 197, 94, 0.05);
        }
        .style-card.selected {
            border-color: #4ade80; 
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.4);
            transform: translateY(-2px);
        }
        .loader {
            border-top-color: #22c55e;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast {
            animation: fadeInOut 5s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .file-upload-area {
            border: 2px dashed #4b5563;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: #22c55e;
            background-color: rgba(34, 197, 94, 0.05);
        }
        .file-preview {
            max-height: 120px;
        }
        #generated-script {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            color: #d1d5db;
            resize: vertical;
            min-height: 150px;
        }
        #generated-script:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 1px #16a34a;
        }
        script[src="https://cdn.tailwindcss.com/3.4.1"] {
            display: none;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">Adsmax Studio <span class="text-green-400">Pro</span></h1>
            <p class="mt-2 text-lg text-gray-400">Dari Satu Gambar, Jadi Konten Iklan Siap Upload (Tanpa Model Manusia)</p>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl shadow-green-900/10 border border-green-500/30">
                <section id="style-selection">
                    <h2 class="text-xl font-semibold mb-1 text-white">Langkah 1: Pilih Gaya Konten</h2>
                    <p class="text-gray-400 mb-5 text-sm">Pilih template untuk menentukan alur cerita visual.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="style-card bg-gray-800 p-4 rounded-lg border-2 border-gray-700 cursor-pointer text-center" data-style="live-showcase">
                            <h3 class="font-semibold text-sm">Live Showcase</h3>
                        </div>
                        <div class="style-card bg-gray-800 p-4 rounded-lg border-2 border-gray-700 cursor-pointer text-center" data-style="quick-insight">
                            <h3 class="font-semibold text-sm">Quick Insight</h3>
                        </div>
                         

</div>
                </section>

                <section id="external-tools" class="mt-8">
                    <h2 class="text-xl font-semibold mb-1 text-white">Akses Fitur AI Tambahan</h2>
                    <p class="text-gray-400 mb-5 text-sm">Klik buka grok untuk generate video</p>
                    <div class="space-y-4">
                        <a href="https://grok.com/" target="_blank" rel="noopener noreferrer" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg shadow-blue-500/30">
                            Buka Grok (X.ai)
                        </a>
                    </div>
                </section>

                <section id="input-form" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold mb-5 text-white">Langkah 2: Sediakan Aset Anda</h2>
                    <div class="space-y-6">
                    </div>
                    <button id="generate-btn" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center shadow-lg shadow-green-500/30">
                        Generate Konten
                    </button>
                </section>
            </div>

            <div class="bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl shadow-green-900/10 border border-green-500/30">
                <h2 class="text-xl font-semibold mb-5 text-white">Hasil Generasi Visual</h2>
                
                <div id="placeholder-output" class="text-center text-gray-500 py-16">
                    <p>Hasil konten Anda akan muncul di sini.</p>
                </div>
                
                <div id="visual-section" class="hidden space-y-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Alur Cerita Visual</h3>
                        <div id="image-grid" class="grid grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl shadow-green-900/10 border border-green-500/30">
                <h2 class="text-xl font-semibold mb-5 text-white">Hasil Generasi Naskah</h2>

                <div id="script-placeholder-output" class="text-center text-gray-500 py-16">
                    <p>Naskah dan audio akan muncul di sini.</p>
                </div>

                <div class="space-y-8">
                    <div id="script-section" class="hidden">
                        <h3 class="text-lg font-semibold mb-4">Naskah (Bisa Diedit)</h3>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <textarea id="generated-script" rows="6" placeholder="Naskah akan muncul di sini..."></textarea>
                        </div>
                    </div>

                    <div id="script-audio-section" class="hidden">
                         <h3 class="text-lg font-semibold mb-4">Naskah &amp; Audio Detil</h3>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="mt-4 flex flex-wrap items-center gap-4">
                                <select id="tts-voice" class="bg-gray-700 text-white rounded-lg px-3 py-2 text-sm border-gray-600"></select>
                                <button id="tts-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Buat Audio</button>
                                <div id="audio-player-controls" class="hidden">
                                    <button id="play-audio-btn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full">
                                        <svg id="play-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /></svg>
                                        <svg id="pause-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6" /></svg>
                                    </button>
                                    <audio id="audio-player" class="hidden"></audio>
                                </div>
                                <button id="download-audio-btn" class="hidden bg-green-600 hover:bg-green-700 text-white p-2 rounded-full" title="Unduh Audio">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                     <div id="download-section" class="text-center hidden pt-4 flex flex-col sm:flex-row justify-center gap-4">
                        <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                            Unduh Semua Gambar
                        </button>
                        <button id="download-prompts-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                            Unduh Teks Prompt (.txt)
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4 mx-auto"></div>
            <p id="loading-message" class="text-white text-xl">AI sedang bekerja...</p>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>
    

<script>
document.addEventListener('DOMContentLoaded', () => {
    let selectedStyle = null, uploadedFiles = {}, generatedContent = { masterScene: null, images: [], audio: null, shotPrompts: [] };
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
    const dom = {
        styleCards: document.querySelectorAll('.style-card'),
        inputForm: document.getElementById('input-form'),
        inputFormContainer: document.querySelector('#input-form .space-y-6'),
        generateBtn: document.getElementById('generate-btn'),
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingMessage: document.getElementById('loading-message'),
        toastContainer: document.getElementById('toast-container'),
        placeholderOutput: document.getElementById('placeholder-output'), 
        scriptPlaceholderOutput: document.getElementById('script-placeholder-output'),
        visualSection: document.getElementById('visual-section'),
        scriptSection: document.getElementById('script-section'), 
        scriptAudioSection: document.getElementById('script-audio-section'),
        downloadSection: document.getElementById('download-section'),
        generatedScriptEl: document.getElementById('generated-script'),
        ttsBtn: document.getElementById('tts-btn'),
        ttsVoiceSelect: document.getElementById('tts-voice'),
        audioPlayer: document.getElementById('audio-player'),
        audioPlayerControls: document.getElementById('audio-player-controls'),
        imageGrid: document.getElementById('image-grid'),
        downloadBtn: document.getElementById('download-btn'),
        playAudioBtn: document.getElementById('play-audio-btn'),
        playIcon: document.getElementById('play-icon'),
        pauseIcon: document.getElementById('pause-icon'),
        downloadAudioBtn: document.getElementById('download-audio-btn'),
        downloadPromptsBtn: document.getElementById('download-prompts-btn'),
    };

    const API_KEY = "AIzaSyDHRqIdIoMd-jbiQRBjR2stPuxxWMyCP5E"; // Harap masukkan API key Anda di sini jika diperlukan
    const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
    const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;
    const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

    const ttsVoices = [
        { id: 'Orus', name: 'Pria - Tegas' }, { id: 'Charon', name: 'Pria - Ramah' }, { id: 'Fenrir', name: 'Pria - Bersemangat' }
    ];
    
    // Gaya Runway Mode dan Editorial Shots dihapus karena biasanya melibatkan model
    const storyFlows = {
        'live-showcase': [
            { id: 'problem', label: 'The Problem: Visualisasi masalah (tanpa produk utama).' },
            { id: 'reveal', label: 'The Product Reveal: Bidikan sinematik yang memperkenalkan produk.' },
            { id: 'action', label: 'The Solution in Action: Tangan menggunakan produk untuk mengatasi masalah.' },
            { id: 'result', label: 'The Positive Result: Visual hasil akhir yang memuaskan dari produk.' },
            { id: 'presenter', label: 'The Presenter: Tangan memegang produk, menunjukkannya ke kamera.' }
        ],
        'quick-insight': [
            { id: 'hook', label: 'Cinematic Hook: Bidikan lebar yang indah dari produk di lingkungannya.' },
            { id: 'closeup', label: 'Feature Close-Up: Bidikan close-up pada detail terbaik dari produk.' },
            { id: 'solution1', label: 'Solution Part 1: Tangan menggunakan produk dari satu sudut.' },
            { id: 'solution2', label: 'Solution Part 2: Tangan menggunakan produk dari sudut lain, menunjukkan fungsi yang berbeda.' },
            { id: 'result', label: 'The Satisfying Result: Hasil akhir yang memuaskan setelah menggunakan produk.' }
        ]
    };

    const showToast = (message, isError = false) => {
        const toast = document.createElement('div');
        toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        toast.textContent = message;
        dom.toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    };

    const showLoading = (message) => {
        dom.loadingMessage.textContent = message;
        dom.loadingOverlay.classList.remove('hidden');
    };

    const hideLoading = () => {
        dom.loadingOverlay.classList.add('hidden');
    };

    const updateUIForStyle = (style) => {
        selectedStyle = style;
        dom.styleCards.forEach(card => card.classList.toggle('selected', card.dataset.style === style));
        dom.inputFormContainer.innerHTML = '';
        uploadedFiles = {};
        
        const createFileInput = (id, label, required = false, multiple = false) => `<div class="relative"><label class="block text-sm font-medium text-gray-300 mb-2">${label}${required ? '<span class="text-red-400">*</span>' : ''}</label><div id="upload-area-${id}" class="file-upload-area rounded-lg p-4 text-center cursor-pointer"><input type="file" id="${id}" class="hidden" accept="image/*" ${multiple ? 'multiple' : ''}><div id="preview-${id}" class="flex justify-center items-center flex-wrap gap-2"><span class="text-gray-400">Klik atau jatuhkan file</span></div></div><button id="clear-${id}" class="hidden absolute top-0 right-0 mt-2 mr-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">&times;</button></div>`;
        const createTextInput = (id, label, placeholder) => `<div><label for="${id}" class="block text-sm font-medium text-gray-300">${label}<span class="text-red-400">*</span></label><textarea id="${id}" rows="3" class="mt-2 block w-full rounded-md bg-gray-800 border-gray-600 text-white focus:ring-green-500 focus:border-green-500" placeholder="${placeholder}"></textarea></div>`;
        
        let formHtml = '';
        formHtml += createFileInput('productImage', 'Unggah Gambar Produk', true);
        formHtml += createTextInput('productDescription', 'Deskripsi Produk/Masalah/Hiasan', 'Contoh: Keripik singkong renyah dengan bumbu balado pedas manis, di atas meja kayu dengan mangkuk keramik dan daun mint...');
        
        dom.inputFormContainer.innerHTML = formHtml;
        
        dom.inputFormContainer.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', handleFileSelect);
            const dropArea = document.getElementById(`upload-area-${input.id}`);
            const clearBtn = document.getElementById(`clear-${input.id}`);

            if (dropArea) {
                dropArea.addEventListener('click', (e) => {
                    if (e.target.id === `clear-${input.id}`) return;
                    input.click();
                });
                
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('border-green-500', 'bg-green-900/10');
                });
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('border-green-500', 'bg-green-900/10');
                });
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('border-green-500', 'bg-green-900/10');
                    input.files = e.dataTransfer.files;
                    handleFileSelect({ target: input }); 
                });
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    input.value = ''; 
                    uploadedFiles[input.id] = null; 
                    const previewEl = document.getElementById(`preview-${input.id}`);
                    previewEl.innerHTML = '<span class="text-gray-400">Klik atau jatuhkan file</span>'; 
                    clearBtn.classList.add('hidden'); 
                });
            }
        });

        dom.inputForm.classList.remove('hidden');
    };

    const handleFileSelect = async (event) => {
        const input = event.target;
        const files = input.files;
        if (!files || files.length === 0) return;

        try {
            const previewEl = document.getElementById(`preview-${input.id}`);
            previewEl.innerHTML = '';
            if (input.multiple) {
                uploadedFiles[input.id] = [];
                for (const file of files) {
                    const dataUrl = await fileToDataURL(file);
                    uploadedFiles[input.id].push({ name: file.name, type: file.type, base64: dataUrl.split(',')[1] });
                    previewEl.innerHTML += `<img src="${dataUrl}" class="file-preview rounded-md">`;
                }
            } else {
                const dataUrl = await fileToDataURL(files[0]);
                uploadedFiles[input.id] = { name: files[0].name, type: files[0].type, base64: dataUrl.split(',')[1] };
                previewEl.innerHTML = `<img src="${dataUrl}" class="file-preview rounded-md">`;
            }
            const clearBtn = document.getElementById(`clear-${input.id}`);
            if(clearBtn) clearBtn.classList.remove('hidden');

        } catch (error) { showToast(error.message, true); }
    };

    const fileToDataURL = (file) => new Promise((resolve, reject) => {
        if (file.size > MAX_FILE_SIZE) return reject(new Error(`File terlalu besar (maks 5MB).`));
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    const cropImageTo916 = (base64Data) => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const originalWidth = img.width;
            const originalHeight = img.height;
            const targetRatio = 9 / 16;
            const originalRatio = originalWidth / originalHeight;

            if (Math.abs(originalRatio - targetRatio) < 0.01) {
                resolve(base64Data);
                return;
            }

            let newWidth, newHeight, startX, startY;

            if (originalRatio > targetRatio) { 
                newHeight = originalHeight;
                newWidth = newHeight * targetRatio;
                startX = (originalWidth - newWidth) / 2;
                startY = 0;
            } else { 
                newWidth = originalWidth;
                newHeight = newWidth / targetRatio;
                startX = 0;
                startY = (originalHeight - newHeight) / 2;
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            ctx.drawImage(img, startX, startY, newWidth, newHeight, 0, 0, newWidth, newHeight);
            
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = (err) => {
            console.error("Gagal memuat gambar untuk di-crop:", err);
            reject(new Error("Gagal memuat gambar base64 untuk cropping."));
        };
        img.src = base64Data;
    });

    const apiCall = async (url, payload) => {
        // Implementasi retry dengan exponential backoff sederhana
        const maxRetries = 3;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (error) {
                    console.error("Gagal mem-parsing JSON:", responseText);
                    throw new Error("Respons API tidak valid.");
                }
                if (!response.ok) {
                    // Cek jika error 400, yang bisa berarti payload salah
                    if (response.status === 400 && attempt === maxRetries - 1) {
                         throw new Error(`API Error 400: ${data?.error?.message || 'Payload tidak valid.'}`);
                    }
                    console.error(`API Error ${response.status} attempt ${attempt + 1}:`, data);
                    throw new Error(`API Error ${response.status}: ${data?.error?.message || 'Unknown error'}`);
                }
                return data;
            } catch (error) {
                if (attempt === maxRetries - 1) throw error; 
                await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000));
            }
        }
        throw new Error("Gagal menghubungkan ke API setelah beberapa percobaan.");
    };
    
    const getCreativePlan = async () => {
        const description = document.getElementById('productDescription')?.value || 'Produk';
        const storyFlow = storyFlows[selectedStyle] || [];
        const storyFlowString = JSON.stringify(storyFlow.map(s => s.label));

        // --- MODIFIKASI: Instruksi Karakter diubah total untuk tanpa model ---
        const promptText = `
        Anda adalah seorang sutradara dan penulis naskah AI. Tugas Anda adalah membuat rencana kreatif lengkap untuk sebuah video iklan pendek.
        INPUT:
        - Gaya Video: "${selectedStyle}"
        - Deskripsi Produk/Elemen Pendukung: "${description}"
        - Alur Cerita yang Diinginkan: ${storyFlowString}
        TUGAS:
        1.  **Buat Master Scene:** Deskripsikan SATU "Master Scene" yang akan menjadi dasar konsistensi. Deskripsinya harus SANGAT DETAIL dan mencakup:
            - **Fokus Utama (WAJIB):** Fokus harus pada produk utama.
            - **Elemen Pelengkap (JIKA ADA):** Deskripsikan elemen pelengkap seperti hiasan, latar belakang, tekstur, atau tangan (jika interaksi produk memerlukan tangan). **PENTING: JANGAN gunakan model manusia (pria atau wanita). Jika ada tangan, pastikan hanya tangan yang terlihat, bukan bagian tubuh lainnya.**
            - **Latar Belakang:** Deskripsikan latar belakang yang spesifik dan konsisten (contoh: 'di atas meja kayu minimalis dengan pencahayaan lembut').
        2.  **Buat Naskah Video:** Tulis naskah TikTok **tepat 50 kata**.
        3.  **Rancang Prompt Gambar (PALING PENTING):** Berdasarkan "Master Scene" dan alur cerita, tulis LIMA prompt gambar yang siap pakai. Setiap prompt harus deskriptif, naratif, dan menggabungkan semua detail dari Master Scene untuk konsistensi. Pastikan setiap prompt menyertakan perintah teknis: 'ultra-realistic, hyper-detailed 4K photo, professional camera shot, 9:16 portrait'. Produk utama (dari gambar yang diunggah) harus ditampilkan dengan jelas, kecuali adegan "The Problem". JANGAN PERNAH menambahkan model manusia (pria atau wanita) ke dalam gambar. Jika ada tangan, pastikan hanya tangan yang berinteraksi dengan produk.
        OUTPUT (HANYA FORMAT JSON YANG VALID):
        {
          "masterScene": { "focus": "...", "elements": "...", "background": "..." },
          "tiktokScript": "Naskah video lengkap di sini...",
          "shotPrompts": [ "Prompt 1...", "Prompt 2...", "Prompt 3...", "Prompt 4...", "Prompt 5..." ]
        }`;

        const payload = { contents: [{ parts: [{ text: promptText }] }] };
        if(uploadedFiles.productImage) payload.contents[0].parts.push({ inlineData: { mimeType: uploadedFiles.productImage.type, data: uploadedFiles.productImage.base64 } });
        // Model Image dihapus dari payload
        
        try {
            const result = await apiCall(TEXT_API_URL, payload);
            const textResponse = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonResponse = JSON.parse(textResponse);
            if (!jsonResponse.masterScene || !jsonResponse.shotPrompts || jsonResponse.shotPrompts.length === 0) throw new Error("Struktur Rencana Kreatif dari AI tidak valid.");
            generatedContent.masterScene = jsonResponse.masterScene;
            generatedContent.masterScene.tiktokScript = jsonResponse.tiktokScript;
            generatedContent.shotPrompts = jsonResponse.shotPrompts;
        } catch (e) {
            console.error("Gagal memproses Rencana Kreatif dari AI:", e);
            throw new Error("Gagal membuat rencana kreatif dari AI. Coba lagi.");
        }
    };

    const getAnimationPrompt = async (generatedImage) => {
        if (!generatedImage || !generatedImage.success) return null;
        const promptText = `Lihat gambar ini. Buat satu saran prompt video yang menggabungkan SATU gerakan kamera (contoh: 'Kamera dolly in') DENGAN SATU gerakan objek/produk/tangan (contoh: 'produk berputar perlahan'). Jaga agar tetap singkat dan to the point. OUTPUT (HANYA FORMAT JSON YANG VALID): {"videoPrompt": "..."}`;
        const payload = { contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: 'image/png', data: generatedImage.base64.split(',')[1] } }] }] };
        try {
            const result = await apiCall(TEXT_API_URL, payload);
            const textResponse = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(textResponse).videoPrompt;
        } catch (error) {
            console.error("Gagal membuat saran animasi:", error);
            return "Kamera dolly in, produk berputar perlahan.";
        }
    };
    
    const displayResults = () => {
        // Runway Mode dan Editorial Shots dihapus, jadi selalu non-fashion
        const isFashion = false; 
        
        dom.placeholderOutput.classList.add('hidden'); 
        dom.scriptPlaceholderOutput.classList.add('hidden');
        
        dom.visualSection.classList.remove('hidden'); 
        dom.scriptSection.classList.toggle('hidden', isFashion); 
        dom.scriptAudioSection.classList.toggle('hidden', isFashion);
        dom.downloadSection.classList.remove('hidden'); 

        if (!isFashion) {
            dom.generatedScriptEl.value = generatedContent.masterScene?.tiktokScript || "";
        }
        
        dom.imageGrid.innerHTML = '';
        const successfulImages = generatedContent.images.filter(img => img.success);

        if(successfulImages.length === 0) {
             showToast('Tidak ada gambar yang berhasil dibuat.', true);
             dom.visualSection.classList.add('hidden'); 
        } else {
             showToast(`Berhasil membuat ${successfulImages.length} gambar!`);
        }
        
        successfulImages.forEach((img, i) => {
            const itemWrapper = document.createElement('div');
            itemWrapper.className = "relative group"; 
            itemWrapper.innerHTML = `
                <div class="bg-gray-800 rounded-lg overflow-hidden aspect-[9/16]">
                    <img src="${img.base64}" class="w-full h-full object-cover">
                </div>
                <a href="${img.base64}" download="gambar_9x16_${i + 1}.png" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="Unduh Gambar 9:16">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                </a>
                <p class="text-xs text-gray-400 mt-2 text-center">${img.videoPrompt || ''}</p>
            `;
            dom.imageGrid.appendChild(itemWrapper);
        });
    };
    
    const generateStoryImages = async () => {
        const images = [];
        const prompts = generatedContent.shotPrompts;
        
        generatedContent.images = []; 

        for (let i = 0; i < prompts.length; i++) {
            const imageResult = await generateSingleImage(prompts[i], i + 1, prompts.length);
            
            if(imageResult.success) {
                 imageResult.videoPrompt = await getAnimationPrompt(imageResult);
            }
            generatedContent.images.push(imageResult);
        }
    };
    
    const generateSingleImage = async (prompt, index, total) => {
        const maxRetries = 3; 
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                showLoading(`Membuat gambar ${index}/${total} (Percobaan ${attempt})...`);
                console.log(`Executing prompt for image ${index} (Attempt ${attempt}):`, prompt);

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { 
                        responseModalities: ['IMAGE'],
                        // PERBAIKAN: Parameter aspectRatio dan quality dihapus karena menyebabkan Error 400 pada model gemini-2.5-flash-image-preview
                        // aspectRatio: "PORTRAIT_9_16", 
                        // quality: "hd" 
                    }
                };
                const parts = payload.contents[0].parts;
                
                const isProblemShot = (storyFlows[selectedStyle] && storyFlows[selectedStyle][index-1]?.id === 'problem');
                
                if (!isProblemShot && uploadedFiles.productImage) { 
                    parts.push({ inlineData: { mimeType: uploadedFiles.productImage.type, data: uploadedFiles.productImage.base64 } });
                }

                const result = await apiCall(IMAGE_API_URL, payload);
                const imagePart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                
                if (!imagePart || !imagePart.inlineData.data) {
                    console.warn(`Percobaan ${attempt} untuk gambar ${index} tidak menghasilkan data gambar. Respon:`, result);
                    throw new Error('API tidak mengembalikan data gambar.');
                }
                
                const originalBase64Data = `data:image/png;base64,${imagePart.inlineData.data}`;
                
                showLoading(`Memproses & memotong gambar ${index}/${total} ke 9:16...`);
                const croppedBase64Data = await cropImageTo916(originalBase64Data);

                return { base64: croppedBase64Data, success: true, label: `Adegan ${index}` };

            } catch (error) {
                console.error(`Gagal membuat gambar ${index} percobaan ${attempt}/${maxRetries}:`, error);
                
                if (attempt === maxRetries) {
                    showToast(`Gagal total membuat gambar ${index}. Cek API Key & batasan domain (jika di GitHub Pages).`, true);
                    return { base64: null, success: false, error: `Gagal total membuat gambar ${index}.`, label: `Adegan ${index}` };
                }
                
                showToast(`Gagal membuat gambar ${index}, mencoba lagi...`, true);
                await new Promise(res => setTimeout(res, 2000));
            }
        }
        return { base64: null, success: false, error: `Gagal total membuat gambar ${index}.`, label: `Adegan ${index}` };
    };

    dom.generateBtn.addEventListener('click', async () => {
        if (!selectedStyle) {
            showToast('Pilih gaya konten terlebih dahulu.', true);
            return;
        }
        
        dom.visualSection.classList.add('hidden');
        dom.scriptSection.classList.add('hidden');
        dom.scriptAudioSection.classList.add('hidden');
        dom.downloadSection.classList.add('hidden');
        dom.placeholderOutput.classList.remove('hidden');
        dom.scriptPlaceholderOutput.classList.remove('hidden');
        
        generatedContent = { masterScene: null, images: [], audio: null, shotPrompts: [] };
        
        try {
            showLoading('Menganalisis & merancang rencana kreatif...');
            await getCreativePlan();
            
            showLoading('Membuat alur cerita visual...');
            await generateStoryImages();
            
            displayResults();
        } catch (error) { 
            showToast(`Proses gagal: ${error.message}`, true);
        } finally {
            hideLoading();
        }
    });

    dom.ttsBtn.addEventListener('click', async () => {
        const script = dom.generatedScriptEl.value;
        if (!script) { showToast('Naskah kosong.', true); return; }
        
        dom.ttsBtn.disabled = true;
        dom.ttsBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Membuat Audio...`;
        dom.ttsBtn.classList.add('inline-flex', 'items-center', 'justify-center');
        dom.audioPlayerControls.classList.add('hidden');

        try {
            const payload = { contents: [{ parts: [{ text: `Ucapkan dengan gaya natural, hangat, dan antusias: "${script}"` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: dom.ttsVoiceSelect.value } } } }, model: "gemini-2.5-flash-preview-tts" };
            const result = await apiCall(TTS_API_URL, payload);
            const audioPart = result?.candidates?.[0]?.content?.parts?.[0];
            if (audioPart?.inlineData?.data) {
                const sampleRate = parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioPart.inlineData.data);
                const wavBlob = pcmToWav(new Int16Array(pcmData), 1, sampleRate);
                generatedContent.audio = { blob: wavBlob };
                dom.audioPlayer.src = audioUrl;
                dom.audioPlayerControls.classList.remove('hidden');
                dom.downloadAudioBtn.classList.remove('hidden'); 
            } else throw new Error('Data audio tidak valid.');
        } catch (error) { showToast(`Gagal membuat audio: ${error.message}`, true); } 
        finally { 
            dom.ttsBtn.disabled = false;
            dom.ttsBtn.innerHTML = 'Buat Audio';
            dom.ttsBtn.classList.remove('inline-flex', 'items-center', 'justify-center');
        }
    });
    
    dom.playAudioBtn.addEventListener('click', () => {
        if (dom.audioPlayer.paused) {
            dom.audioPlayer.play();
            dom.playIcon.classList.add('hidden');
            dom.pauseIcon.classList.remove('hidden');
        } else {
            dom.audioPlayer.pause();
            dom.playIcon.classList.remove('hidden');
            dom.pauseIcon.classList.add('hidden');
        }
    });
    dom.audioPlayer.onended = () => {
        dom.playIcon.classList.remove('hidden');
        dom.pauseIcon.classList.add('hidden');
    };

    dom.downloadAudioBtn.addEventListener('click', () => {
        if (!generatedContent.audio || !generatedContent.audio.blob) {
            return showToast('Audio belum dibuat.', true);
        }
        const link = document.createElement('a');
        link.href = URL.createObjectURL(generatedContent.audio.blob);
        link.download = "audio.wav";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    dom.downloadBtn.addEventListener('click', () => {
        const successfulImages = generatedContent.images.filter(img => img.success);
        if (successfulImages.length === 0) {
            return showToast('Tidak ada gambar untuk diunduh.', true);
        }
        
        successfulImages.forEach((img, i) => {
            const link = document.createElement('a');
            link.href = img.base64;
            link.download = `adegan_9x16_${i + 1}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    dom.downloadPromptsBtn.addEventListener('click', () => {
        if (generatedContent.shotPrompts.length === 0) {
            return showToast('Tidak ada prompt untuk diunduh.', true);
        }

        let textContent = `--- PROMPT MASTER ---\n`;
        textContent += `Fokus Utama: ${generatedContent.masterScene?.focus || 'N/A'}\n`;
        textContent += `Elemen Pelengkap: ${generatedContent.masterScene?.elements || 'N/A'}\n`;
        textContent += `Latar Belakang: ${generatedContent.masterScene?.background || 'N/A'}\n\n`;
        
        textContent += `--- NASKAH VIDEO ---\n`;
        textContent += `${generatedContent.masterScene?.tiktokScript || 'N/A'}\n\n`;

        textContent += `--- PROMPT ADEGAN ---\n`;
        generatedContent.shotPrompts.forEach((prompt, i) => {
            textContent += `Adegan ${i + 1}:\n${prompt}\n\n`;
        });
        
        textContent += `--- SARAN PROMPT VIDEO (Animasi) ---\n`;
         generatedContent.images.filter(img => img.success && img.videoPrompt).forEach((img, i) => {
            textContent += `Adegan ${i + 1}: ${img.videoPrompt}\n`;
         });

        const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "prompts_konten.txt";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    dom.styleCards.forEach(card => {
        card.addEventListener('click', () => {
            updateUIForStyle(card.dataset.style);
        });
    });

    function base64ToArrayBuffer(base64) {
        const binary_string = atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function pcmToWav(pcmData, numChannels, sampleRate) {
        const buffer = new ArrayBuffer(44 + pcmData.byteLength);
        const view = new DataView(buffer);
        const writeString = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
        const blockAlign = numChannels * 2;
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + pcmData.byteLength, true);
        view.setUint32(4, 36 + pcmData.byteLength, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * blockAlign, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, 'data');
        view.setUint32(40, pcmData.byteLength, true);
        new Int16Array(buffer, 44).set(pcmData);
        return new Blob([view], { type: 'audio/wav' });
    }

    dom.ttsVoiceSelect.innerHTML = ttsVoices.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
});
</script>
</body>
</html>
